/*******************************************************************************
 * This file is part of jPlot
 * Copyright (C) 2016 Bert Vandenbroucke (bert.vandenbroucke@gmail.com)
 *
 * jPlot is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * jPlot is distributed in the hope that it will be useful,
 * but WITOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with jPlot. If not, see <http://www.gnu.org/licenses/>.
 ******************************************************************************/

function log10(a){return Math.log(a)/Math.LN10}function randStr(){var a=Math.random().toString(36).slice(2);while(!isNaN(a[0])){a=Math.random().toString(36).slice(2)}return a}function get_current_script(){var b=document.currentScript;if(b){return b}var a=document.scripts;b=a[a.length-1];return b}var Figure=function(a,c){var b=get_current_script().parentElement;if(typeof a=="undefined"){a=800}if(typeof c=="undefined"){c=0.75*a}this.w=a;this.h=c;this.id=randStr();var d=document.createElement("div");d.id=this.id;d.style.width=a+"px";d.style.height=c+"px";b.appendChild(d)};Figure.prototype.create_plot=function(){return new Plot("#"+this.id,this.w,this.h)};var AxisLocator=function(c,b,a){if(typeof a==="undefined"){a=false}this.islog=a;this.minval=d3.min(c,function(e){if(e.selected){return e[b]}else{return Number.MAX_VALUE}});this.maxval=d3.max(c,function(e){if(e.selected){return e[b]}else{return -Number.MAX_VALUE}});if(this.islog){this.minval=log10(this.minval);this.maxval=log10(this.maxval)}this.minval=Math.floor(this.minval);this.maxval=Math.ceil(this.maxval);this.size=this.maxval-this.minval};AxisLocator.prototype.get_coord=function(a){if(this.islog){a=log10(a)}return(a-this.minval)/this.size};AxisLocator.prototype.get_major_ticks=function(){var b=[];for(var a=this.minval;a<=this.maxval;++a){b.push((a-this.minval)/this.size)}return b};AxisLocator.prototype.get_major_labels=function(){var b=[];for(var a=this.minval;a<=this.maxval;++a){if(this.islog){b.push("\\(10^{"+a+"}\\)")}else{b.push("\\("+a+"\\)")}}return b};AxisLocator.prototype.get_minor_ticks=function(){var c=[];if(this.islog){for(var b=this.minval;b<=this.maxval;++b){for(var a=2;a<10;++a){c.push((b+log10(a)-this.minval)/this.size)}}}else{for(var b=this.minval;b<=this.maxval;++b){for(var a=1;a<10;++a){c.push((b+0.1*a-this.minval)/this.size)}}}return c};var StringFilter=function(a,b){this.key=a;this.value=new RegExp(b)};StringFilter.prototype.filter=function(b){var a=this;b.forEach(function(c){if(!a.value.exec(c[a.key])){c.selected=false}})};var FloatFilter=function(a,b){this.key=a;this.value=b};FloatFilter.prototype.filter=function(b){var a=this;b.forEach(function(c){if(c[a.key]==a.value){c.selected=false}})};var Plot=function(e,a,c){this.ready=true;this.plotready=true;this.limits_valid=false;this.queue=[];if(typeof a==="undefined"){a=700}if(typeof c==="undefined"){c=500}this.height=c;this.width=a;this.plotwidth=0.9*this.width;this.plotheight=0.9*this.height;var b=d3.select(e);b.attr("style","position: relative;                             width: "+this.width+"px;                             height: "+this.height+"px");this.svg=b.append("svg").attr("width",this.plotwidth).attr("height",this.plotheight).attr("style","position: absolute;                    left: "+(this.width-this.plotwidth)+"px;                    top: 0");this.xlabel=b.append("p").text("\\(x\\)-label").attr("style","position: absolute; top: 100px");this.ylabel=b.append("p").text("\\(y\\)-label").attr("style","position: absolute; top: 100px");this.xticks=b.append("div").attr("style","position: absolute;                    top: "+this.plotheight+"px;                    left: "+(this.width-this.plotwidth)+"px;                    height: "+0.5*(this.height-this.plotheight)+"px;                    width: "+this.plotwidth+"px;                    font-size: 75%");this.yticks=b.append("div").attr("style","position: absolute;                    top: 0;                    left: "+0.5*(this.width-this.plotwidth)+"px;                    width: "+0.5*(this.width-this.plotwidth)+"px;                    height: "+this.plotheight+"px;                    font-size: 75%");var d=this.svg.append("g");this.add_line(d,1,1,1,this.plotheight);this.add_line(d,1,this.plotheight-1,this.plotwidth,this.plotheight-1);this.add_line(d,this.plotwidth-1,1,this.plotwidth-1,this.plotheight-1);this.add_line(d,1,1,this.plotwidth,1);this.plotgroup=this.svg.append("g");this.move_labels();MathJax.Hub.Queue(["Typeset",MathJax.Hub])};Plot.prototype.move_labels=function(){var m=this.xlabel[0][0].clientWidth;var i=this.xlabel[0][0].clientHeight;var c=0.5*(this.height+this.plotheight);var l=this.width-0.5*(this.plotwidth+m);this.xlabel.attr("style","position: absolute;                               top: "+c+"px;                               left: "+l+"px;                               margin: 0px");var e=this.ylabel[0][0].clientWidth;var a=this.ylabel[0][0].clientHeight;var b=0.5*(this.plotheight-a);var k=0.5*(this.width-this.plotwidth-a-e);this.ylabel.attr("style","position: absolute;                               top: "+b+"px;                               left: "+k+"px;                               margin: 0px;                               -ms-transform: rotate(-90deg);                               -webkit-transform: rotate(-90deg);                               transform: rotate(-90deg)");if(!this.limits_valid){var o=this.xticks.selectAll("p")[0];for(var j=0;j<o.length;++j){var d=o[j].clientWidth;var n=parseFloat(o[j].style.left);o[j].style.left=n-0.5*d+"px"}var g=this.yticks.selectAll("p")[0];for(var j=0;j<g.length;++j){var h=g[j].clientHeight;var f=parseFloat(g[j].style.top);g[j].style.top=f-0.5*h+"px"}this.limits_valid=true}};Plot.prototype.add_line=function(e,b,d,a,c){e.append("line").attr("x1",b).attr("y1",d).attr("x2",a).attr("y2",c).attr("style","stroke: rgb(0,0,0); stroke-width: 1")};Plot.prototype.add_point=function(i,h,g,a){if(typeof a==="undefined"){a="kox"}var b=/[os\^]/;var d=b.exec(a)[0];var l=/[rbgakyldqpcemtn]/;var c=l.exec(a);var e=/[xz]/;var k=e.exec(a)[0];var f={r:"red",b:"blue",g:"green",a:"gray",k:"black",y:"yellow",l:"darkgreen",d:"darkblue",q:"darkred",p:"purple",c:"cyan",e:"orange",m:"magenta",t:"seagreen",n:"orangered"};var j="transparent";if(k=="x"){j=f[c]}switch(d){case"o":i.append("circle").attr("cx",h).attr("cy",g).attr("r",5).attr("stroke",f[c]).attr("fill",j);break;case"s":i.append("rect").attr("x",h-5).attr("y",g-5).attr("width",10).attr("height",10).attr("stroke",f[c]).attr("fill",j);break;case"^":i.append("polygon").attr("points",h+","+(g-5)+" "+(h+5)+","+(g+5)+" "+(h-5)+","+(g+5)).attr("stroke",f[c]).attr("fill",j)}};Plot.prototype.load_data=function(b){var c="load_data_"+b;this.queue.push(c);var a=this;this.loaded=false;d3.tsv(b,function(d){d.forEach(function(g){for(var f in g){var e=+g[f];if(!isNaN(e)){g[f]=e}}g.selected=true});a.data=d;a.loaded=true;a.queue.shift()})};Plot.prototype.is_ready=function(a){var e=a.callee.name;for(var b=0;b<a.length;b++){e+="_"+a[b]}var d=Array.prototype.slice.call(a);if(this.queue.indexOf(e)<0){var c=Math.random();d[a.length]=c;e+="_"+c;this.queue.push(e)}if(this.queue[0]!=e){setTimeout(a.callee.bind.apply(a.callee,[this].concat(d)),10);return false}else{this.queue.shift();return true}};Plot.prototype.filter=function filter(b,c){if(!this.is_ready(arguments)){return}var a;if(!isNaN(+c)){a=new FloatFilter(b,c)}else{a=new StringFilter(b,c)}a.filter(this.data);this.ready=true};Plot.prototype.set_limits=function set_limits(f,d,a,h){if(!this.is_ready(arguments)){return}if(!this.xlocator){this.xlocator=new AxisLocator(this.data,f,a);this.ylocator=new AxisLocator(this.data,d,h);var b=this.xlocator.get_minor_ticks();for(var c in b){tick=b[c];this.add_line(this.plotgroup,tick*this.plotwidth,0,tick*this.plotwidth,5);this.add_line(this.plotgroup,tick*this.plotwidth,this.plotheight,tick*this.plotwidth,this.plotheight-5)}b=this.xlocator.get_major_ticks();for(var c in b){tick=b[c];this.add_line(this.plotgroup,tick*this.plotwidth,0,tick*this.plotwidth,10);this.add_line(this.plotgroup,tick*this.plotwidth,this.plotheight,tick*this.plotwidth,this.plotheight-10)}var i=this.ylocator.get_minor_ticks();for(var c in i){tick=i[c];this.add_line(this.plotgroup,0,(1-tick)*this.plotheight,5,(1-tick)*this.plotheight);this.add_line(this.plotgroup,this.plotwidth,(1-tick)*this.plotheight,this.plotwidth-5,(1-tick)*this.plotheight)}i=this.ylocator.get_major_ticks();for(var c in i){tick=i[c];this.add_line(this.plotgroup,0,(1-tick)*this.plotheight,10,(1-tick)*this.plotheight);this.add_line(this.plotgroup,this.plotwidth,(1-tick)*this.plotheight,this.plotwidth-10,(1-tick)*this.plotheight)}var j=this.xlocator.get_major_labels();for(var g in j){this.xticks.append("p").attr("style","position: absolute;                            margin: 0px;                            left: "+b[g]*this.plotwidth+"px").text(j[g])}var e=this.ylocator.get_major_labels();for(var g in e){this.yticks.append("p").attr("style","position: absolute;                            margin: 0px;                            top: "+(1-i[g])*this.plotheight+"px;                            right: 0px").text(e[g])}this.limits_valid=false}};Plot.prototype.commonplot=function commonplot(g,e,a,j,c){if(!this.is_ready(arguments)){return}var k=this;if(typeof c==="undefined"){c="ko"}if(!this.xlocator){this.xlocator=new AxisLocator(this.data,g,a);this.ylocator=new AxisLocator(this.data,e,j);var b=this.xlocator.get_minor_ticks();for(var d in b){tick=b[d];this.add_line(this.plotgroup,tick*this.plotwidth,0,tick*this.plotwidth,5);this.add_line(this.plotgroup,tick*this.plotwidth,this.plotheight,tick*this.plotwidth,this.plotheight-5)}b=this.xlocator.get_major_ticks();for(var d in b){tick=b[d];this.add_line(this.plotgroup,tick*this.plotwidth,0,tick*this.plotwidth,10);this.add_line(this.plotgroup,tick*this.plotwidth,this.plotheight,tick*this.plotwidth,this.plotheight-10)}var i=this.ylocator.get_minor_ticks();for(var d in i){tick=i[d];this.add_line(this.plotgroup,0,(1-tick)*this.plotheight,5,(1-tick)*this.plotheight);this.add_line(this.plotgroup,this.plotwidth,(1-tick)*this.plotheight,this.plotwidth-5,(1-tick)*this.plotheight)}i=this.ylocator.get_major_ticks();for(var d in i){tick=i[d];this.add_line(this.plotgroup,0,(1-tick)*this.plotheight,10,(1-tick)*this.plotheight);this.add_line(this.plotgroup,this.plotwidth,(1-tick)*this.plotheight,this.plotwidth-10,(1-tick)*this.plotheight)}var l=this.xlocator.get_major_labels();for(var h in l){this.xticks.append("p").attr("style","position: absolute;                            margin: 0px;                            left: "+b[h]*this.plotwidth+"px").text(l[h])}var f=this.ylocator.get_major_labels();for(var h in f){this.yticks.append("p").attr("style","position: absolute;                            margin: 0px;                            top: "+(1-i[h])*this.plotheight+"px;                            right: 0px").text(f[h])}this.limits_valid=false}this.xlabel.text(g);this.ylabel.text(e);MathJax.Hub.Register.StartupHook("End Typeset",this.move_labels.bind(this));MathJax.Hub.Queue(["Typeset",MathJax.Hub]);this.data.forEach(function(n){if(n.selected){var m=k.xlocator.get_coord(n[g]);var o=k.ylocator.get_coord(n[e]);k.add_point(k.plotgroup,m*k.plotwidth,(1-o)*k.plotheight,c)}});this.plotready=true};Plot.prototype.set_xlabel=function set_xlabel(a){if(!this.is_ready(arguments)){return}this.xlabel.text(a);MathJax.Hub.Queue(["Typeset",MathJax.Hub])};Plot.prototype.set_ylabel=function set_ylabel(a){if(!this.is_ready(arguments)){return}this.ylabel.text(a);MathJax.Hub.Queue(["Typeset",MathJax.Hub])};Plot.prototype.loglog=function(c,b,a){this.commonplot(c,b,true,true,a)};Plot.prototype.semilogx=function(c,b,a){this.commonplot(c,b,true,false,a)};Plot.prototype.semilogy=function(c,b,a){this.commonplot(c,b,false,true,a)};Plot.prototype.plot=function(c,b,a){this.commonplot(c,b,false,false,a)};Plot.prototype.clear=function clear(){if(!this.is_ready(arguments)){return}this.plotgroup.remove();this.plotgroup=this.svg.append("g");this.xlabel.text("\\(x\\)-label");this.ylabel.text("\\(y\\)-label");this.xticks.selectAll("p").remove();this.yticks.selectAll("p").remove();this.xlocator=null;this.ylocator=null;MathJax.Hub.Queue(["Typeset",MathJax.Hub])};Plot.prototype.clear_filter=function clear_filter(){if(!this.is_ready(arguments)){return}this.data.forEach(function(a){a.selected=true})};
